<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Larrak Orchestrator Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script>
    <script src="tools.js"></script>
    <style>
        :root {
            --bg-color: #0d1117;
            --text-color: #c9d1d9;
            --border-color: #30363d;
            --accent-color: #58a6ff;
            --card-bg: #161b22;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, Arial, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .container {
            max-width: 1200px;
            width: 100%;
        }

        h1 {
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 10px;
        }

        .grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 20px;
        }

        .card {
            background-color: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            padding: 20px;
        }

        .full-width {
            grid-column: 1 / -1;
        }

        .status-badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.8em;
            font-weight: bold;
        }

        .status-offline {
            background-color: #da3633;
            color: white;
        }

        .status-online {
            background-color: #238636;
            color: white;
        }

        .diagram {
            background-color: white;
            /* Mermaid needs light bg usually or extensive config */
            border-radius: 6px;
            padding: 10px;
            overflow-x: auto;
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 100;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background-color: #fefefe;
            padding: 20px;
            border-radius: 8px;
            width: 80%;
            max-width: 800px;
            position: relative;
        }

        .close-btn {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }

        .close-btn:hover,
        .close-btn:focus {
            color: black;
            text-decoration: none;
            cursor: pointer;
        }
    </style>
</head>

<body>

    <div class="container">
        <h1>Larrak Orchestrator Dashboard</h1>

        <div class="grid">
            <div class="card">
                <h2>System Status</h2>
                <p><strong>Orchestrator:</strong> <span class="status-badge status-online">Integrated</span></p>
                <p><strong>Weaviate Tracking:</strong> <span class="status-badge status-online">Online</span></p>
                <p><small>(Provenance logging active)</small></p>
            </div>

            <div class="card">
                <h2>Module Connectivity</h2>
                <p>The Orchestrator gates optimization via three loops:</p>
                <ul>
                    <li><strong>Outer Loop:</strong> CEM Feasibility (Geometry validation)</li>
                    <li><strong>Middle Loop:</strong> Surrogate Prediction (Fast ML filtering)</li>
                    <li><strong>Inner Loop:</strong> Trust-Region Solver (IPOPT Refinement)</li>
                </ul>
            </div>

            <div class="card full-width">
                <h2>Architecture Diagram</h2>
                <div class="diagram">
                    <div class="mermaid">
                        graph TD
                        %% Styling
                        classDef core fill:#e1f5fe,stroke:#01579b,stroke-width:3px,color:#0d47a1
                        classDef module fill:#e8f5e9,stroke:#1b5e20,stroke-width:3px,color:#1b5e20
                        classDef db fill:#f3e5f5,stroke:#4a148c,stroke-width:3px,color:#4a148c
                        classDef hifi fill:#fff3e0,stroke:#e65100,stroke-width:3px,color:#e65100
                        classDef util fill:#fce4ec,stroke:#880e4f,stroke-width:2px,color:#880e4f
                        classDef invis fill:none,stroke:none

                        %% Make arrows thicker and easier to see
                        linkStyle default stroke-width:3px,fill:none,stroke:#666

                        subgraph Orchestrator_Context [Orchestrator Control Layer]
                        direction TB
                        ORCH[Orchestrator]

                        subgraph Internals [State Management]
                        direction LR
                        BM[Budget Manager]
                        TR[Trust Region]
                        CACHE[Eval Cache]
                        end

                        ORCH -.- BM
                        ORCH -.- TR
                        ORCH -.- CACHE
                        end

                        subgraph Pipeline [Fast Optimization Loop]
                        direction TB
                        CEM[1. CEM: Generate & Repair]
                        SUR[2. Surrogate: Predict + Uncertainty]
                        SOL[3. Solver: Local Refinement]
                        SEL[4. Budget Select: Pick for Eval]
                        end

                        subgraph HiFi [HiFi Solvers - Offline DOE]
                        direction LR
                        FOAM[üî• laplacianFoam]
                        CCX[‚öôÔ∏è CalculiX]
                        PORTFLOW[üí® simpleFoam]
                        COMBUST[üî∂ reactingFoam]
                        end

                        subgraph Data [Data Layer - Weaviate Tracked]
                        direction LR
                        TRUTH[(Truth DB)]
                        WEAV[(Vector DB)]
                        PROV[Provenance Client]
                        end

                        %% Fast Optimization Loop (green - main pipeline)
                        ORCH ==>|generate_batch| CEM
                        CEM ==>|candidates| SUR
                        SUR ==>|predict| SOL
                        SOL ==>|refine| SEL
                        SEL ==>|select| ORCH

                        %% Budget gates expensive evals (blue - caching)
                        SEL -.->|get_or_compute| CACHE
                        CACHE -.->|cached_result| SEL

                        %% Orchestrator calls HiFi for DOE (orange - HiFi dispatch)
                        ORCH -.->|thermal_solve| FOAM
                        ORCH -.->|structural_solve| CCX
                        ORCH -.->|port_flow_solve| PORTFLOW
                        ORCH -.->|combustion_solve| COMBUST

                        %% HiFi results go to Truth DB (orange - HiFi store)
                        FOAM -.->|T_crown_max| TRUTH
                        CCX -.->|von_mises_max| TRUTH
                        PORTFLOW -.->|Cd, swirl| TRUTH
                        COMBUST -.->|Wiebe a,m| TRUTH

                        %% Truth DB feeds Surrogate training (purple - data flow)
                        TRUTH -.->|update| SUR
                        TRUTH -.->|embed| WEAV

                        %% Surrogates query Vector DB (purple - data flow)
                        WEAV -.->|similarity| SUR

                        %% Provenance logging (red - logging)
                        ORCH -.->|start_run| PROV
                        PROV -.->|insert| WEAV

                        %% Link Styles by process type
                        %% 0-4: Optimization loop (green)
                        linkStyle 0 stroke:#2e7d32,stroke-width:4px
                        linkStyle 1 stroke:#2e7d32,stroke-width:4px
                        linkStyle 2 stroke:#2e7d32,stroke-width:4px
                        linkStyle 3 stroke:#2e7d32,stroke-width:4px
                        linkStyle 4 stroke:#2e7d32,stroke-width:4px
                        %% 5-6: Cache check (cyan)
                        linkStyle 5 stroke:#0097a7,stroke-width:3px
                        linkStyle 6 stroke:#0097a7,stroke-width:3px
                        %% 7-10: DOE dispatch (orange)
                        linkStyle 7 stroke:#e65100,stroke-width:3px
                        linkStyle 8 stroke:#e65100,stroke-width:3px
                        linkStyle 9 stroke:#e65100,stroke-width:3px
                        linkStyle 10 stroke:#e65100,stroke-width:3px
                        %% 11-14: HiFi store (orange-red)
                        linkStyle 11 stroke:#d84315,stroke-width:3px
                        linkStyle 12 stroke:#d84315,stroke-width:3px
                        linkStyle 13 stroke:#d84315,stroke-width:3px
                        linkStyle 14 stroke:#d84315,stroke-width:3px
                        %% 15-16: Training data (purple)
                        linkStyle 15 stroke:#7b1fa2,stroke-width:3px
                        linkStyle 16 stroke:#7b1fa2,stroke-width:3px
                        %% 17: Vector query (purple)
                        linkStyle 17 stroke:#7b1fa2,stroke-width:3px
                        %% 18-19: Provenance (red)
                        linkStyle 18 stroke:#c62828,stroke-width:3px
                        linkStyle 19 stroke:#c62828,stroke-width:3px

                        %% Classes
                        class ORCH,BM,TR,CACHE core
                        class CEM,SUR,SOL,SEL module
                        class TRUTH,WEAV,PROV db
                        class FOAM,CCX,PORTFLOW,COMBUST hifi
                        class Internals invis

                        %% Interaction
                        click ORCH clickORCH
                        click CEM clickCEM
                        click SUR clickSUR
                        click SOL clickSOL
                        click BM clickBM
                        click TR clickTR
                        click CACHE clickCACHE
                        click SEL clickSEL
                        click FOAM clickFOAM
                        click CCX clickCCX
                        click PORTFLOW clickPORTFLOW
                        click COMBUST clickCOMBUST
                        click TRUTH clickTRUTH
                        click WEAV clickWEAV
                        click PROV clickPROV
                    </div>
                </div>
                <p align="center"><em>Click any node to expand internal process</em></p>

                <!-- Legend -->
                <div style="display: flex; justify-content: center; margin-top: 15px;">
                    <div
                        style="background: #f5f5f5; border-radius: 8px; padding: 15px 25px; display: inline-flex; gap: 30px; flex-wrap: wrap;">
                        <!-- Node Colors -->
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <div
                                style="width: 16px; height: 16px; background: #e1f5fe; border: 2px solid #01579b; border-radius: 3px;">
                            </div>
                            <span style="font-size: 0.85em; color: #333;">Core / State</span>
                        </div>
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <div
                                style="width: 16px; height: 16px; background: #e8f5e9; border: 2px solid #1b5e20; border-radius: 3px;">
                            </div>
                            <span style="font-size: 0.85em; color: #333;">Pipeline Module</span>
                        </div>
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <div
                                style="width: 16px; height: 16px; background: #fff3e0; border: 2px solid #e65100; border-radius: 3px;">
                            </div>
                            <span style="font-size: 0.85em; color: #333;">HiFi Solver</span>
                        </div>
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <div
                                style="width: 16px; height: 16px; background: #f3e5f5; border: 2px solid #4a148c; border-radius: 3px;">
                            </div>
                            <span style="font-size: 0.85em; color: #333;">Data Layer</span>
                        </div>
                        <div style="border-left: 2px solid #ccc; height: 24px; margin: 0 10px;"></div>
                        <!-- Trace Colors -->
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <div style="width: 24px; height: 4px; background: #2e7d32; border-radius: 2px;"></div>
                            <span style="font-size: 0.85em; color: #333;">Optimization Loop</span>
                        </div>
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <div style="width: 24px; height: 4px; background: #0097a7; border-radius: 2px;"></div>
                            <span style="font-size: 0.85em; color: #333;">Cache Check</span>
                        </div>
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <div style="width: 24px; height: 4px; background: #e65100; border-radius: 2px;"></div>
                            <span style="font-size: 0.85em; color: #333;">HiFi Dispatch</span>
                        </div>
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <div style="width: 24px; height: 4px; background: #d84315; border-radius: 2px;"></div>
                            <span style="font-size: 0.85em; color: #333;">HiFi Store</span>
                        </div>
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <div style="width: 24px; height: 4px; background: #7b1fa2; border-radius: 2px;"></div>
                            <span style="font-size: 0.85em; color: #333;">Data Flow</span>
                        </div>
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <div style="width: 24px; height: 4px; background: #c62828; border-radius: 2px;"></div>
                            <span style="font-size: 0.85em; color: #333;">Provenance</span>
                        </div>
                    </div>
                </div>
            </div>


            <!-- HiFi Simulation Runs Card - Linked to Stage 4: Simulation -->
            <div class="card full-width">
                <h2>üñ•Ô∏è HiFi Simulation Runs <span class="status-badge status-online">Tracked</span></h2>
                <p>Expensive CFD/FEA simulations at <strong>Stage 4: Ground Truth</strong> that generate training data.
                </p>

                <div style="display: flex; gap: 20px; flex-wrap: wrap; margin-top: 15px;">
                    <!-- OpenFOAM -->
                    <div
                        style="flex: 1; min-width: 250px; background: linear-gradient(135deg, #ff7043, #ff5722); padding: 15px; border-radius: 8px; color: white;">
                        <h3 style="margin: 0 0 10px 0;">üî• OpenFOAM (Thermal)</h3>
                        <table style="width: 100%; font-size: 0.9em;">
                            <tr>
                                <td>Solver:</td>
                                <td><code>laplacianFoam</code></td>
                            </tr>
                            <tr>
                                <td>Output:</td>
                                <td>T_crown_max (K)</td>
                            </tr>
                            <tr>
                                <td>Docker Image:</td>
                                <td><code>openfoam11-paraview510</code></td>
                            </tr>
                            <tr>
                                <td>Workflow Stage:</td>
                                <td><strong>simulation</strong></td>
                            </tr>
                        </table>
                    </div>

                    <!-- CalculiX -->
                    <div
                        style="flex: 1; min-width: 250px; background: linear-gradient(135deg, #42a5f5, #1e88e5); padding: 15px; border-radius: 8px; color: white;">
                        <h3 style="margin: 0 0 10px 0;">‚öôÔ∏è CalculiX (Structural)</h3>
                        <table style="width: 100%; font-size: 0.9em;">
                            <tr>
                                <td>Solver:</td>
                                <td><code>ccx</code></td>
                            </tr>
                            <tr>
                                <td>Output:</td>
                                <td>von_mises_max (MPa)</td>
                            </tr>
                            <tr>
                                <td>Docker Image:</td>
                                <td><code>calculix/ccx</code></td>
                            </tr>
                            <tr>
                                <td>Workflow Stage:</td>
                                <td><strong>simulation</strong></td>
                            </tr>
                        </table>
                    </div>

                    <!-- Port Flow CFD -->
                    <div
                        style="flex: 1; min-width: 250px; background: linear-gradient(135deg, #66bb6a, #43a047); padding: 15px; border-radius: 8px; color: white;">
                        <h3 style="margin: 0 0 10px 0;">üí® Port Flow (Fluid)</h3>
                        <table style="width: 100%; font-size: 0.9em;">
                            <tr>
                                <td>Solver:</td>
                                <td><code>simpleFoam</code></td>
                            </tr>
                            <tr>
                                <td>Output:</td>
                                <td>Cd, swirl/tumble ratio</td>
                            </tr>
                            <tr>
                                <td>Docker Image:</td>
                                <td><code>openfoam11-paraview510</code></td>
                            </tr>
                            <tr>
                                <td>Workflow Stage:</td>
                                <td><strong>simulation</strong></td>
                            </tr>
                        </table>
                    </div>

                    <!-- Combustion CFD -->
                    <div
                        style="flex: 1; min-width: 250px; background: linear-gradient(135deg, #ffb74d, #ff9800); padding: 15px; border-radius: 8px; color: white;">
                        <h3 style="margin: 0 0 10px 0;">üî∂ Combustion (Prechamber)</h3>
                        <table style="width: 100%; font-size: 0.9em;">
                            <tr>
                                <td>Solver:</td>
                                <td><code>reactingFoam</code></td>
                            </tr>
                            <tr>
                                <td>Output:</td>
                                <td>Wiebe params, p_max</td>
                            </tr>
                            <tr>
                                <td>Docker Image:</td>
                                <td><code>openfoam11-paraview510</code></td>
                            </tr>
                            <tr>
                                <td>Workflow Stage:</td>
                                <td><strong>simulation</strong></td>
                            </tr>
                        </table>
                    </div>
                </div>

                <p style="margin-top: 15px; color: #888; font-size: 0.9em;">
                    <strong>Weaviate Collection:</strong> <code>HiFiSimulationRun</code> |
                    <strong>Properties:</strong> run_id, solver_type, case_path, compute_time_s, success, result_json
                </p>
            </div>
        </div>
    </div>

    <!-- Drill-Down Modal -->
    <div id="modal" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="closeModal()">&times;</span>
            <h2 id="modal-title">Module Detail</h2>
            <div id="modal-diagram" class="diagram"></div>
        </div>
    </div>

    <script>
        // Sub-diagram definitions
        const diagrams = {
            "CEM": `graph LR
                classDef step fill:#e8f5e9,stroke:#1b5e20,stroke-width:2px
                classDef tool fill:#fff9c4,stroke:#f57f17,stroke-width:2px
                Start((Start)) --> Env[Envelope Sampling]
                Env --> Check{Check Feasibility}
                Check -- Yes --> Batch[Add to Batch]
                Check -- No --> Repair[Repair with Constraints]
                Repair --> Check
                Batch --> End((Return Batch))
                subgraph Tools [üîß Tools]
                T1[gRPC Server]
                T2[C++ Core]
                T3[NumPy]
                end
                class Env,Check,Repair,Batch step
                class T1,T2,T3 tool`,

            "SUR": `graph LR
                classDef step fill:#e3f2fd,stroke:#0277bd,stroke-width:2px
                classDef tool fill:#fff9c4,stroke:#f57f17,stroke-width:2px
                Input(Batch) --> Feat[Feature Extraction]
                Feat --> Ensemble[Ensemble Forward Pass]
                Ensemble --> Mean[Mean Prediction]
                Ensemble --> Std[Uncertainty Est.]
                Mean --> Filter[Filter Top K]
                Std --> End((Return Predictions))
                Filter --> End
                subgraph Tools [üîß Tools]
                T1[PyTorch]
                T2[EnsembleSurrogate]
                T3[NumPy]
                end
                class Feat,Ensemble,Mean,Std,Filter step
                class T1,T2,T3 tool`,

            "SOL": `graph TD
                classDef step fill:#fff3e0,stroke:#ef6c00,stroke-width:2px
                classDef tool fill:#fff9c4,stroke:#f57f17,stroke-width:2px
                Input(Candidate) --> Trust[Apply Trust Region]
                Trust --> NLP[Build NLP Problem]
                NLP --> IPOPT[Call IPOPT Solver]
                IPOPT --> Check{Converged?}
                Check -- Yes --> Opt[Store Local Optima]
                Check -- No --> Fail[Mark Invalid]
                Opt --> End((Return Result))
                Fail --> End
                subgraph Tools [üîß Tools]
                T1[CasADi]
                T2[IPOPT]
                T3[MA57 / HSL]
                T4[collocation_nlp]
                end
                class Trust,NLP,IPOPT,Check,Opt,Fail step
                class T1,T2,T3,T4 tool`,

            "SIM": `graph LR
                classDef step fill:#fce4ec,stroke:#c2185b,stroke-width:2px
                classDef tool fill:#fff9c4,stroke:#f57f17,stroke-width:2px
                Input(Params) --> Setup[Setup Physics Kernel]
                Setup --> Eval[Execute Simulation]
                Eval --> Metrics[Calculate Efficiency]
                Metrics --> Cost[Compute Cost Function]
                Cost --> End((Return Truth))
                subgraph Tools [üîß Tools]
                T1[HiFiSimulationAdapter]
                T2[Docker Containers]
                T3[result_parsers.py]
                end
                class Setup,Eval,Metrics,Cost step
                class T1,T2,T3 tool`,

            "ORCH": `graph TD
                classDef step fill:#f3e5f5,stroke:#7b1fa2,stroke-width:2px
                classDef tool fill:#fff9c4,stroke:#f57f17,stroke-width:2px
                Start((Start)) --> Init[Initialize Budget]
                Init --> Loop{Budget > 0?}
                Loop -- Yes --> Step1[Sample & Predict]
                Step1 --> Step2[Refine Candidates]
                Step2 --> Step3[Simulate & Update]
                Step3 --> Loop
                Loop -- No --> End((Final Solution))
                subgraph Tools [üîß Tools]
                T1[Orchestrator class]
                T2[BudgetManager]
                T3[TrustRegion]
                T4[ProvenanceClient]
                end
                class Init,Loop,Step1,Step2,Step3 step
                class T1,T2,T3,T4 tool`,

            "BM": `graph TD
                classDef step fill:#e1f5fe,stroke:#01579b,stroke-width:2px
                classDef db fill:#f3e5f5,stroke:#4a148c,stroke-width:2px
                classDef tool fill:#fff9c4,stroke:#f57f17,stroke-width:2px
                Budget((Total Budget)) --> Split[Allocate: 40% Best / 30% Uncertain / 20% Disagree / 10% Random]
                Split --> Track[Track Consumption]
                Track --> Reserve[Reserve 10% for Validation]
                Reserve --> End((Remaining))
                Track -.-> W[(Weaviate: Run)]
                subgraph Tools [üîß Tools]
                T1[budget.py]
                T2[NumPy]
                end
                class Split,Track,Reserve step
                class W db
                class T1,T2 tool`,

            "TR": `graph TD
                classDef step fill:#e1f5fe,stroke:#01579b,stroke-width:2px
                Pred((Predicted)) --> Compare{Actual Match?}
                Act((Actual)) --> Compare
                Compare -- Yes --> Expand[Expand Radius x1.5]
                Compare -- No --> Contract[Contract Radius x0.5]
                Expand --> Bound[Bound Step Size]
                Contract --> Bound
                Bound --> End((New Bounds))
                class Compare,Expand,Contract,Bound step`,

            "CACHE": `graph LR
                classDef step fill:#e1f5fe,stroke:#01579b,stroke-width:2px
                classDef tool fill:#fff9c4,stroke:#f57f17,stroke-width:2px
                Input((Params)) --> Hash[SHA-256 Hash]
                Hash --> Check{In Cache?}
                Check -- Hit --> Return[Return Cached Result]
                Check -- Miss --> Compute[Run HiFi Simulation]
                Compute --> Store[Store in LRU Cache]
                Store --> Return
                Return --> End((Result + was_cached))
                subgraph Tools [üîß Tools]
                T1[cache.py]
                T2[hashlib]
                T3[functools.lru_cache]
                end
                class Hash,Check,Return,Compute,Store step
                class T1,T2,T3 tool`,

            "SEL": `graph TD
                classDef step fill:#e8f5e9,stroke:#1b5e20,stroke-width:2px
                classDef db fill:#f3e5f5,stroke:#4a148c,stroke-width:2px
                Input((Refined Candidates)) --> Best[Top K by Prediction]
                Input --> Uncertain[Top K by Uncertainty]
                Input --> Random[Random Sample]
                Best --> Merge[Merge & Dedupe]
                Uncertain --> Merge
                Random --> Merge
                Merge --> End((Selected Indices))
                Merge -.-> W[(Weaviate: Run.selection_log)]
                class Best,Uncertain,Random,Merge step
                class W db`,

            "FOAM": `graph TD
                classDef step fill:#fff3e0,stroke:#e65100,stroke-width:2px
                classDef db fill:#f3e5f5,stroke:#4a148c,stroke-width:2px
                classDef tool fill:#fff9c4,stroke:#f57f17,stroke-width:2px
                Input((Geometry)) --> Mesh[blockMesh / snappyHexMesh]
                Mesh --> BC[Set Thermal BCs]
                BC --> Solve[Run laplacianFoam]
                Solve --> Parse[Extract T_crown_max]
                Parse --> End((Output))
                Parse -.-> W[(HiFiSimulationRun)]
                subgraph Tools [üîß Tools]
                T1[OpenFOAM 11]
                T2[Docker]
                T3[thermal_cfd.py]
                end
                class Mesh,BC,Solve,Parse step
                class W db
                class T1,T2,T3 tool`,

            "CCX": `graph TD
                classDef step fill:#fff3e0,stroke:#e65100,stroke-width:2px
                classDef db fill:#f3e5f5,stroke:#4a148c,stroke-width:2px
                classDef tool fill:#fff9c4,stroke:#f57f17,stroke-width:2px
                Input((Geometry + Loads)) --> Mesh[Gmsh .inp Generation]
                Mesh --> BC[Apply Pressure + Thermal BCs]
                BC --> Solve[Run CalculiX ccx]
                Solve --> Parse[Extract von_mises_max]
                Parse --> End((Output))
                Parse -.-> W[(HiFiSimulationRun)]
                subgraph Tools [üîß Tools]
                T1[CalculiX 2.21]
                T2[Gmsh]
                T3[gear_contact.py]
                end
                class Mesh,BC,Solve,Parse step
                class W db
                class T1,T2,T3 tool`,

            "PORTFLOW": `graph TD
                classDef step fill:#fff3e0,stroke:#e65100,stroke-width:2px
                classDef db fill:#f3e5f5,stroke:#4a148c,stroke-width:2px
                classDef tool fill:#fff9c4,stroke:#f57f17,stroke-width:2px
                Input((Port Geometry)) --> Mesh[Generate Port Mesh]
                Mesh --> BC[Set Inlet/Outlet BCs]
                BC --> Solve[Run simpleFoam]
                Solve --> Parse[Extract Cd, Swirl, Tumble]
                Parse --> End((Output))
                Parse -.-> W[(HiFiSimulationRun)]
                subgraph Tools [üîß Tools]
                T1[OpenFOAM 11]
                T2[Docker]
                T3[port_flow_cfd.py]
                end
                class Mesh,BC,Solve,Parse step
                class W db
                class T1,T2,T3 tool`,

            "COMBUST": `graph TD
                classDef step fill:#fff3e0,stroke:#e65100,stroke-width:2px
                classDef db fill:#f3e5f5,stroke:#4a148c,stroke-width:2px
                classDef tool fill:#fff9c4,stroke:#f57f17,stroke-width:2px
                Input((Chamber + Mixture)) --> Mesh[Generate Combustion Mesh]
                Mesh --> Chem[Setup Chemistry: PaSR/EDC]
                Chem --> Solve[Run reactingFoam 5ms]
                Solve --> Parse[Extract Wiebe a,m + p_max]
                Parse --> End((Output))
                Parse -.-> W[(HiFiSimulationRun)]
                subgraph Tools [üîß Tools]
                T1[OpenFOAM 11]
                T2[reactingFoam]
                T3[combustion_cfd.py]
                end
                class Mesh,Chem,Solve,Parse step
                class W db
                class T1,T2,T3 tool`,

            "TRUTH": `graph LR
                classDef step fill:#f3e5f5,stroke:#4a148c,stroke-width:2px
                classDef db fill:#f3e5f5,stroke:#4a148c,stroke-width:2px
                HiFi((HiFi Results)) --> Store[Store Ground Truth]
                Store --> Embed[Create Embeddings]
                Embed --> Train[Feed to Surrogate.update]
                Store --> W1[(HiFiSimulationRun)]
                Embed --> W2[(Vector Index)]
                class Store,Embed,Train step
                class W1,W2 db`,

            "WEAV": `graph TD
                classDef coll fill:#f3e5f5,stroke:#4a148c,stroke-width:2px
                subgraph Collections [16 Weaviate Collections]
                Run[Run]
                Geometry[Geometry]
                HiFi[HiFiSimulationRun]
                DOE[DOEPoint]
                Code[CodeFile]
                Constraint[ConstraintResult]
                end
                Query((Query)) --> Search[Vector + Hybrid Search]
                Search --> Results((Results))
                class Run,Geometry,HiFi,DOE,Code,Constraint coll`,

            "PROV": `graph TD
                classDef step fill:#f3e5f5,stroke:#4a148c,stroke-width:2px
                classDef db fill:#f3e5f5,stroke:#4a148c,stroke-width:2px
                Event((Orchestrator Event)) --> Log[ProvenanceClient]
                Log --> Run[start_run / end_run]
                Log --> Geom[log_geometry]
                Log --> Check[log_constraint_check]
                Run --> W[(Run Collection)]
                Geom --> W2[(Geometry Collection)]
                Check --> W3[(ConstraintResult)]
                class Log,Run,Geom,Check step
                class W,W2,W3 db`
        };

        const modal = document.getElementById("modal");
        const modalTitle = document.getElementById("modal-title");
        const modalDiagram = document.getElementById("modal-diagram");

        function openModal(nodeId, title) {
            if (diagrams[nodeId]) {
                modalTitle.innerText = title;

                // Get tools from tools.js (sourced from Weaviate via module_linker.py)
                const tools = typeof getModuleTools === 'function' ? getModuleTools(nodeId) : [];
                let toolsHtml = '';
                if (tools.length > 0) {
                    toolsHtml = `
                        <div style="margin-top: 20px; padding: 15px; background: #1e1e1e; border-radius: 8px; border-left: 4px solid #f57f17;">
                            <h4 style="margin: 0 0 10px 0; color: #f57f17;">üîß Tools (from Weaviate)</h4>
                            <div style="display: flex; flex-wrap: wrap; gap: 8px;">
                                ${tools.map(t => `<span style="background: #2d2d2d; padding: 4px 10px; border-radius: 4px; font-size: 0.85em; color: #e0e0e0;">${t.name} <span style="color: #888; font-size: 0.8em;">${t.version}</span></span>`).join('')}
                            </div>
                        </div>`;
                }

                modalDiagram.innerHTML = `<div class="mermaid">${diagrams[nodeId]}</div>${toolsHtml}`;
                modal.style.display = "flex";
                mermaid.init(undefined, modalDiagram.querySelector(".mermaid"));
            }
        }

        function closeModal() {
            modal.style.display = "none";
        }

        // Close on outside click
        window.onclick = function (event) {
            if (event.target == modal) {
                closeModal();
            }
        }

        // Mermaid Click Bindings
        // Note: Mermaid callbacks look for global functions
        window.clickCEM = () => openModal("CEM", "CEM: Feasibility Generation");
        window.clickSUR = () => openModal("SUR", "Surrogate: Inference Model");
        window.clickSOL = () => openModal("SOL", "Solver: Local Refinement");
        window.clickSIM = () => openModal("SIM", "Simulation: Ground Truth");
        window.clickORCH = () => openModal("ORCH", "Orchestrator Logic");

        // State Management
        window.clickBM = () => openModal("BM", "Budget Manager");
        window.clickTR = () => openModal("TR", "Trust Region");
        window.clickCACHE = () => openModal("CACHE", "Evaluation Cache");
        window.clickSEL = () => openModal("SEL", "Budget Selection");

        // HiFi Solvers
        window.clickFOAM = () => openModal("FOAM", "OpenFOAM laplacianFoam (Thermal)");
        window.clickCCX = () => openModal("CCX", "CalculiX FEA (Structural)");
        window.clickPORTFLOW = () => openModal("PORTFLOW", "OpenFOAM simpleFoam (Flow)");
        window.clickCOMBUST = () => openModal("COMBUST", "OpenFOAM reactingFoam (Combustion)");

        // Data Layer
        window.clickTRUTH = () => openModal("TRUTH", "Truth Database");
        window.clickWEAV = () => openModal("WEAV", "Weaviate Vector DB");
        window.clickPROV = () => openModal("PROV", "Provenance Client");

        mermaid.initialize({
            startOnLoad: true,
            securityLevel: 'loose' // Required for interaction
        });
    </script>

</body>

</html>